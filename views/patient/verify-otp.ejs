<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <title>Verify OTP - Healora</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

  <link rel="stylesheet" href="/css/verify-otp.css">
</head>
<body>
  <div class="otp-container">
    <div class="icon-wrapper">
      <i class="fas fa-envelope-open-text"></i>
    </div>

    <h2>Verify Your Email</h2>
    <p class="subtitle">We've sent a 6-digit verification code to your email</p>

    <div id="alertBox" class="alert"></div>

    <form id="otpForm" novalidate>
      <div class="otp-input-wrapper">
        <input type="text" maxlength="1" class="otp-input" id="otp1" autofocus>
        <input type="text" maxlength="1" class="otp-input" id="otp2">
        <input type="text" maxlength="1" class="otp-input" id="otp3">
        <input type="text" maxlength="1" class="otp-input" id="otp4">
        <input type="text" maxlength="1" class="otp-input" id="otp5">
        <input type="text" maxlength="1" class="otp-input" id="otp6">
      </div>

      <button type="submit" class="btn-verify" id="verifyBtn">
        <i class="fas fa-check-circle"></i> Verify OTP
      </button>
    </form>

    <div class="resend-section">
      <p class="resend-text">Didn't receive the code?</p>
      <a href="#" class="resend-link" id="resendOtp">
        <i class="fas fa-redo"></i> Resend OTP
      </a>
      <div class="timer" id="timer"></div>
    </div>
  </div>

  <script>
    const alertBox = document.getElementById('alertBox');
    const verifyBtn = document.getElementById('verifyBtn');
    const otpInputs = document.querySelectorAll('.otp-input');

    function showAlert(message, type) {
      alertBox.textContent = message;
      alertBox.className = `alert alert-${type}`;
      alertBox.style.display = 'block';
      setTimeout(() => {
        alertBox.style.display = 'none';
      }, 5000);
    }

    otpInputs.forEach((input, index) => {
      input.addEventListener('input', (e) => {
        const value = e.target.value;
        
        if (!/^\d*$/.test(value)) {
          e.target.value = '';
          return;
        }

        if (value.length === 1) {
          input.classList.add('filled');
          if (index < otpInputs.length - 1) {
            otpInputs[index + 1].focus();
          }
        }
      });

      input.addEventListener('keydown', (e) => {
        if (e.key === 'Backspace') {
          if (!e.target.value && index > 0) {
            otpInputs[index - 1].focus();
            otpInputs[index - 1].value = '';
            otpInputs[index - 1].classList.remove('filled');
          } else {
            e.target.classList.remove('filled');
          }
        }
      });

      input.addEventListener('paste', (e) => {
        e.preventDefault();
        const pastedData = e.clipboardData.getData('text').slice(0, 6);
        const digits = pastedData.split('');
        digits.forEach((digit, i) => {
          if (otpInputs[i] && /^\d$/.test(digit)) {
            otpInputs[i].value = digit;
            otpInputs[i].classList.add('filled');
          }
        });
        if (digits.length > 0) {
          otpInputs[Math.min(digits.length, 5)].focus();
        }
      });
    });

    document.getElementById('otpForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const otp = Array.from(otpInputs).map(input => input.value).join('');

      if (otp.length !== 6) {
        showAlert('Please enter all 6 digits', 'error');
        return;
      }

      verifyBtn.disabled = true;
      verifyBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Verifying...';

      try {
        const res = await fetch('/patient/verify-otp', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ otp }) 
        });

        const data = await res.json();

        if (res.ok) {
          showAlert('✓ Email verified! Redirecting...', 'success');
          verifyBtn.innerHTML = '<i class="fas fa-check-circle"></i> Verified!';
          setTimeout(() => {
            window.location.href = data.redirect || '/patient/dashboard';
          }, 1500);
        } else {
          showAlert(data.errors?.otp || data.errors?.general || 'Verification failed', 'error');
          verifyBtn.disabled = false;
          verifyBtn.innerHTML = '<i class="fas fa-check-circle"></i> Verify OTP';
          
          otpInputs.forEach(input => {
            input.value = '';
            input.classList.remove('filled');
          });
          otpInputs[0].focus();
        }
      } catch (err) {
        showAlert('Server error. Please try again.', 'error');
        verifyBtn.disabled = false;
        verifyBtn.innerHTML = '<i class="fas fa-check-circle"></i> Verify OTP';
      }
    });

    let timeLeft = 300;
    const timerElement = document.getElementById('timer');
    const resendLink = document.getElementById('resendOtp');

    function startTimer() {
      timerElement.style.display = 'block';
      resendLink.style.pointerEvents = 'none';
      resendLink.style.opacity = '0.5';

      const countdown = setInterval(() => {
        timeLeft--;
        const minutes = Math.floor(timeLeft / 60);
        const seconds = timeLeft % 60;
        timerElement.textContent = `Code expires in ${minutes}:${seconds.toString().padStart(2, '0')}`;

        if (timeLeft <= 0) {
          clearInterval(countdown);
          timerElement.textContent = 'OTP expired! Click resend to get a new code.';
          timerElement.classList.add('expired');
          resendLink.style.pointerEvents = 'auto';
          resendLink.style.opacity = '1';
        }
      }, 1000);
    }

    startTimer();
    document.getElementById('resendOtp').addEventListener('click', async (e) => {
      e.preventDefault();

      if (timeLeft > 0) {
        showAlert('Please wait for the current OTP to expire', 'error');
        return;
      }

      resendLink.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending...';

      try {
        const res = await fetch('/patient/resend-otp', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({}) 
        });

        const data = await res.json();

        if (res.ok) {
          showAlert('✓ New OTP sent to your email!', 'success');
          timeLeft = 300; 
          startTimer();
          
          otpInputs.forEach(input => {
            input.value = '';
            input.classList.remove('filled');
          });
          otpInputs[0].focus();
        } else {
          showAlert(data.errors?.general || 'Failed to resend OTP', 'error');
        }
      } catch (err) {
        showAlert('Server error. Please try again.', 'error');
      }

      resendLink.innerHTML = '<i class="fas fa-redo"></i> Resend OTP';
    });
  </script>
  <script>
  if (window.history.replaceState) {
    window.history.replaceState(null, null, window.location.href);
  }

  window.addEventListener("popstate", function () {
    window.location.replace("/patient/signup");
  });
</script>

</body>
</html>