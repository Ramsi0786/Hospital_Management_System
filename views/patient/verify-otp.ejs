<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Verify OTP - Healora</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      font-family: 'Poppins', sans-serif;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .otp-container {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      padding: 50px 40px;
      border-radius: 25px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      width: 100%;
      max-width: 480px;
      text-align: center;
      animation: slideUp 0.5s ease-out;
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .icon-wrapper {
      width: 80px;
      height: 80px;
      background: linear-gradient(135deg, #667eea, #764ba2);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 25px;
      box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
    }

    .icon-wrapper i {
      color: white;
      font-size: 35px;
    }

    h2 {
      color: #2d3748;
      font-weight: 700;
      margin-bottom: 15px;
      font-size: 28px;
    }

    .subtitle {
      color: #718096;
      font-size: 15px;
      margin-bottom: 10px;
      line-height: 1.6;
    }

    .email-display {
      color: #667eea;
      font-weight: 600;
      font-size: 16px;
      margin-bottom: 35px;
    }

    .otp-input-wrapper {
      display: flex;
      justify-content: center;
      gap: 12px;
      margin: 35px 0;
    }

    .otp-input {
      width: 55px;
      height: 55px;
      text-align: center;
      font-size: 24px;
      font-weight: 700;
      border: 2px solid #e2e8f0;
      border-radius: 12px;
      outline: none;
      transition: all 0.3s ease;
      background: #f7fafc;
      color: #2d3748;
    }

    .otp-input:focus {
      border-color: #667eea;
      background: white;
      box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
      transform: scale(1.05);
    }

    .otp-input.filled {
      border-color: #667eea;
      background: #f0f4ff;
    }

    .btn-verify {
      width: 100%;
      padding: 15px;
      border-radius: 12px;
      font-weight: 600;
      font-size: 16px;
      border: none;
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      margin-top: 25px;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
    }

    .btn-verify:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 28px rgba(102, 126, 234, 0.4);
    }

    .btn-verify:active {
      transform: translateY(0);
    }

    .btn-verify:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .resend-section {
      margin-top: 25px;
      padding-top: 25px;
      border-top: 1px solid #e2e8f0;
    }

    .resend-text {
      color: #718096;
      font-size: 14px;
      margin-bottom: 8px;
    }

    .resend-link {
      color: #667eea;
      text-decoration: none;
      font-weight: 600;
      font-size: 15px;
      transition: all 0.3s;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .resend-link:hover {
      color: #764ba2;
      gap: 10px;
    }

    .resend-link i {
      font-size: 14px;
    }

    .alert {
      border-radius: 10px;
      padding: 12px 16px;
      margin-bottom: 20px;
      font-size: 14px;
      display: none;
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .alert-error {
      background: #fee;
      color: #c53030;
      border: 1px solid #feb2b2;
    }

    .alert-success {
      background: #f0fff4;
      color: #276749;
      border: 1px solid #9ae6b4;
    }

    .timer {
      color: #667eea;
      font-weight: 600;
      font-size: 14px;
      margin-top: 15px;
      display: none;
    }

    .timer.expired {
      color: #e53e3e;
    }

    @media (max-width: 576px) {
      .otp-container {
        padding: 40px 25px;
      }

      .otp-input {
        width: 45px;
        height: 45px;
        font-size: 20px;
      }

      .otp-input-wrapper {
        gap: 8px;
      }

      h2 {
        font-size: 24px;
      }
    }
  </style>
</head>
<body>

  <div class="otp-container">
    <div class="icon-wrapper">
      <i class="fas fa-envelope-open-text"></i>
    </div>

    <h2>Verify Your Email</h2>
    <p class="subtitle">We've sent a 6-digit verification code to</p>
    <p class="email-display" id="userEmail"></p>

    <div id="alertBox" class="alert"></div>

    <form id="otpForm">
      <div class="otp-input-wrapper">
        <input type="text" maxlength="1" class="otp-input" id="otp1" autofocus>
        <input type="text" maxlength="1" class="otp-input" id="otp2">
        <input type="text" maxlength="1" class="otp-input" id="otp3">
        <input type="text" maxlength="1" class="otp-input" id="otp4">
        <input type="text" maxlength="1" class="otp-input" id="otp5">
        <input type="text" maxlength="1" class="otp-input" id="otp6">
      </div>

      <button type="submit" class="btn-verify" id="verifyBtn">
        <i class="fas fa-check-circle"></i> Verify OTP
      </button>
    </form>

    <div class="resend-section">
      <p class="resend-text">Didn't receive the code?</p>
      <a href="#" class="resend-link" id="resendOtp">
        <i class="fas fa-redo"></i> Resend OTP
      </a>
      <div class="timer" id="timer" style="display:none;"></div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const email = urlParams.get('email');
    document.getElementById('userEmail').textContent = email;

    const otpInputs = document.querySelectorAll('.otp-input');
    const alertBox = document.getElementById('alertBox');
    const verifyBtn = document.getElementById('verifyBtn');

    function showAlert(message, type) {
      alertBox.textContent = message;
      alertBox.className = `alert alert-${type}`;
      alertBox.style.display = 'block';
      setTimeout(() => {
        alertBox.style.display = 'none';
      }, 5000);
    }

    // Auto-focus and validation
    otpInputs.forEach((input, index) => {
      input.addEventListener('input', (e) => {
        const value = e.target.value;
        
        // Only allow numbers
        if (!/^\d*$/.test(value)) {
          e.target.value = '';
          return;
        }

        if (value.length === 1) {
          input.classList.add('filled');
          if (index < otpInputs.length - 1) {
            otpInputs[index + 1].focus();
          }
        }
      });

      input.addEventListener('keydown', (e) => {
        if (e.key === 'Backspace') {
          if (!e.target.value && index > 0) {
            otpInputs[index - 1].focus();
            otpInputs[index - 1].value = '';
            otpInputs[index - 1].classList.remove('filled');
          } else {
            e.target.classList.remove('filled');
          }
        }
      });

      // Paste support
      input.addEventListener('paste', (e) => {
        e.preventDefault();
        const pastedData = e.clipboardData.getData('text').slice(0, 6);
        const digits = pastedData.split('');
        digits.forEach((digit, i) => {
          if (otpInputs[i] && /^\d$/.test(digit)) {
            otpInputs[i].value = digit;
            otpInputs[i].classList.add('filled');
          }
        });
        if (digits.length > 0) {
          otpInputs[Math.min(digits.length, 5)].focus();
        }
      });
    });

    // Submit OTP - AUTO LOGIN AFTER VERIFICATION
    document.getElementById('otpForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const otp = Array.from(otpInputs).map(input => input.value).join('');

      if (otp.length !== 6) {
        showAlert('Please enter all 6 digits', 'error');
        return;
      }

      verifyBtn.disabled = true;
      verifyBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Verifying...';

      try {
        const res = await fetch('/patient/verify-otp', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, otp })
        });

        const data = await res.json();

        if (res.ok) {
          showAlert('✓ Email verified! Redirecting to dashboard...', 'success');
          verifyBtn.innerHTML = '<i class="fas fa-check-circle"></i> Verified!';
          setTimeout(() => {
            // Redirect to dashboard instead of login
            window.location.href = data.redirect || '/patient/dashboard';
          }, 1500);
        } else {
          showAlert(data.errors?.otp || 'Verification failed. Please try again.', 'error');
          verifyBtn.disabled = false;
          verifyBtn.innerHTML = '<i class="fas fa-check-circle"></i> Verify OTP';
          
          // Clear inputs on error
          otpInputs.forEach(input => {
            input.value = '';
            input.classList.remove('filled');
          });
          otpInputs[0].focus();
        }
      } catch (err) {
        showAlert('Server error. Please try again.', 'error');
        verifyBtn.disabled = false;
        verifyBtn.innerHTML = '<i class="fas fa-check-circle"></i> Verify OTP';
      }
    });

    // OTP Timer (5 minutes = 300 seconds)
    let timeLeft = 60;
    const timerElement = document.getElementById('timer');
    const resendLink = document.getElementById('resendOtp');

    function startTimer() {
      timerElement.style.display = 'block';
      resendLink.style.pointerEvents = 'none';
      resendLink.style.opacity = '0.5';

      const countdown = setInterval(() => {
        timeLeft--;
        const minutes = Math.floor(timeLeft / 60);
        const seconds = timeLeft % 60;
        timerElement.textContent = `Code expires in ${minutes}:${seconds.toString().padStart(2, '0')}`;

        if (timeLeft <= 0) {
          clearInterval(countdown);
          timerElement.textContent = 'OTP expired! Click resend to get a new code.';
          timerElement.classList.add('expired');
          resendLink.style.pointerEvents = 'auto';
          resendLink.style.opacity = '1';
        }
      }, 1000);
    }

    // Start timer on page load
    startTimer();

    // Resend OTP
    document.getElementById('resendOtp').addEventListener('click', async (e) => {
      e.preventDefault();

      if (timeLeft > 0) {
        showAlert('Please wait for the current OTP to expire', 'error');
        return;
      }

      resendLink.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending...';

      try {
        const res = await fetch('/patient/resend-otp', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email })
        });

        const data = await res.json();

        if (res.ok) {
          showAlert('✓ New OTP sent to your email!', 'success');
          timeLeft = 60; // Reset timer to 5 minutes
          startTimer();
          
          // Clear OTP inputs
          otpInputs.forEach(input => {
            input.value = '';
            input.classList.remove('filled');
          });
          otpInputs[0].focus();
        } else {
          showAlert(data.errors?.general || 'Failed to resend OTP', 'error');
        }
      } catch (err) {
        showAlert('Server error. Please try again.', 'error');
      }

      resendLink.innerHTML = '<i class="fas fa-redo"></i> Resend OTP';
    });
  </script>

</body>
</html>