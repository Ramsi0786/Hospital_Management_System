<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <title>Patient Profile - Healora</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/css/admin/dashboard.css">
  <link rel="stylesheet" href="/css/admin/profile.css">
</head>
<body>

<%
  // Safety check for appointments
  const appts = (typeof appointments !== 'undefined' && Array.isArray(appointments))
    ? appointments
    : [];
    
  // Determine badge status
  let badgeClass = 'active';
  let badgeText = 'Active';
  
  if (patient.isBlocked) {
    badgeClass = 'blocked';
    badgeText = 'Blocked';
  } else if (!patient.isActive) {
    badgeClass = 'inactive';
    badgeText = 'Inactive';
  }
%>

  <%- include('../partials/admin-sidebar', { currentPage: 'patients' }) %>
  <%- include('../partials/admin-topbar', { admin: admin, breadcrumb: 'Patient Profile' }) %>

  <div class="main-content">
    <a href="/admin/patients" class="back-button">
      <i class="fas fa-arrow-left"></i>
      Back to Patients
    </a>

    <div class="profile-header">
      <div class="profile-content">
        <div class="profile-top">
          <div class="profile-main">
            <div class="profile-avatar-large">
              <% 
                const initials = patient.name
                  ? patient.name.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2)
                  : '--';
              %>
              <%= initials %>
              <div class="status-indicator <%= badgeClass %>"></div>
            </div>

            <div class="profile-info">
              <div class="profile-name-row">
                <h1><%= patient.name %></h1>
                <span class="status-pill <%= badgeClass %>">
                    <% if (patient.isBlocked) { %>
                      <i class="fas fa-ban"></i>
                      <% } else { %>
                        <i class="fas fa-circle status-dot"></i>
                        <% } %>
                  <%= badgeText %></span>
              </div>

              <div class="profile-meta">
                <div class="meta-item">
                  <i class="fas fa-id-card"></i>
                  <span>ID: <%= patient._id.toString().substring(0, 10).toUpperCase() %></span>
                </div>
                <div class="meta-item">
                  <i class="fas fa-calendar"></i>
                  <span>
                    Joined <%= new Date(patient.createdAt).toLocaleDateString('en-US', {
                      year: 'numeric',
                      month: 'long',
                      day: 'numeric'
                    }) %>
                  </span>
                </div>
                <div class="meta-item">
                  <i class="fas fa-envelope"></i>
                  <span><%= patient.email %></span>
                </div>
              </div>
            </div>
          </div>

          <div class="profile-actions">
            <button class="btn-action btn-edit" onclick="showEditModal()">
              <i class="fas fa-edit"></i>
              Edit Profile
            </button>
            <button class="btn-action <%= patient.isBlocked ? 'btn-unblock' : 'btn-block' %>" 
                    onclick="toggleBlock()">
              <i class="fas fa-<%= patient.isBlocked ? 'unlock' : 'ban' %>"></i>
              <%= patient.isBlocked ? 'Unblock' : 'Block' %>
            </button>
            <button class="btn-action btn-delete" onclick="deletePatient()">
              <i class="fas fa-trash"></i>
              Delete
            </button>
          </div>
        </div>
      </div>

      <div class="profile-stats">
        <div class="stat-item">
          <span class="stat-value"><%= appts.length %></span>
          <span class="stat-label">Total Appointments</span>
        </div>
        <div class="stat-item">
          <span class="stat-value"><%= appts.filter(a => a.status === 'completed').length %></span>
          <span class="stat-label">Completed</span>
        </div>
        <div class="stat-item">
          <span class="stat-value"><%= appts.filter(a => a.status === 'pending').length %></span>
          <span class="stat-label">Pending</span>
        </div>
        <div class="stat-item">
          <span class="stat-value"><%= appts.filter(a => a.status === 'cancelled').length %></span>
          <span class="stat-label">Cancelled</span>
        </div>
      </div>
    </div>

    <div class="content-grid">
      <div class="info-card">
        <h3>
          <i class="fas fa-user"></i>
          Basic Information
        </h3>

        <div class="info-row">
          <span class="info-label">Full Name</span>
          <span class="info-value"><%= patient.name %></span>
        </div>

        <div class="info-row">
          <span class="info-label">Email</span>
          <span class="info-value"><%= patient.email %></span>
        </div>

        <div class="info-row">
          <span class="info-label">Phone</span>
          <span class="info-value"><%= patient.phone || '_' %></span>
        </div>

        <div class="info-row">
          <span class="info-label">Age</span>
          <span class="info-value"><%= patient.age || '_' %></span>
        </div>

        <div class="info-row">
          <span class="info-label">Gender</span>
          <span class="info-value"><%= patient.gender || '_' %></span>
        </div>
      </div>

      <!-- Account Details -->
      <div class="info-card">
        <h3>
          <i class="fas fa-info-circle"></i>
          Account Details
        </h3>

        <div class="info-row">
          <span class="info-label">Account Status</span>
          <span class="info-value">
            <span class="status-pill <%= badgeClass %>">
                    <% if (patient.isBlocked) { %>
                      <i class="fas fa-ban"></i>
                      <% } else { %>
                        <i class="fas fa-circle status-dot"></i>
                        <% } %>
                  <%= badgeText %></span>
          </span>
        </div>

        <div class="info-row">
          <span class="info-label">Verified</span>
          <span class="info-value">
            <%= patient.isVerified ? 'Yes' : 'No' %>
          </span>
        </div>

        <div class="info-row">
          <span class="info-label">Member Since</span>
          <span class="info-value">
            <%= new Date(patient.createdAt).toLocaleDateString('en-US', {
              year: 'numeric',
              month: 'short',
              day: 'numeric'
            }) %>
          </span>
        </div>

        <div class="info-row">
          <span class="info-label">Last Updated</span>
          <span class="info-value">
            <%= patient.updatedAt ? new Date(patient.updatedAt).toLocaleDateString('en-US', {
              year: 'numeric',
              month: 'short',
              day: 'numeric'
            }) : 'N/A' %>
          </span>
        </div>

        <div class="info-row">
          <span class="info-label">Last Visit</span>
          <span class="info-value">
            <%
              const lastAppt = appts.length
                ? [...appts].sort((a, b) => new Date(b.date) - new Date(a.date))[0]
                : null;
            %>
            <%= lastAppt ? new Date(lastAppt.date).toLocaleDateString('en-US', {
              year: 'numeric',
              month: 'short',
              day: 'numeric'
            }) : 'Never' %>
          </span>
        </div>
      </div>
    </div>

    <!-- Recent Appointments -->
    <div class="info-card">
      <h3>
        <i class="fas fa-calendar-check"></i>
        Recent Appointments
      </h3>

      <% if (appts.length === 0) { %>
        <div class="empty-state">
          <i class="fas fa-calendar-times"></i>
          <p>No appointments found</p>
        </div>
      <% } else { %>
        <table class="appointments-table">
          <thead>
            <tr>
              <th>Date</th>
              <th>Doctor</th>
              <th>Time</th>
              <th>Department</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody>
            <% appts.slice(0, 10).forEach(appointment => { %>
              <tr>
                <td>
                  <%= new Date(appointment.date).toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                  }) %>
                </td>
                <td>Dr. <%= appointment.doctorName || 'Unknown' %></td>
                <td><%= appointment.time || 'N/A' %></td>
                <td><%= appointment.department || 'N/A' %></td>
                <td>
                  <span class="status-badge status-<%= appointment.status || 'pending' %>">
                    <%= (appointment.status || 'pending').toUpperCase() %>
                  </span>
                </td>
              </tr>
            <% }) %>
          </tbody>
        </table>
      <% } %>
    </div>
  </div>

  <!-- Edit Modal -->
  <div class="modal-overlay" id="editModal">
    <div class="modal-content-custom">
      <div class="modal-header">
        <h3>Edit Patient</h3>
        <button class="btn-close-modal" onclick="closeEditModal()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <form id="editForm">
        <div class="modal-body">
          <div class="form-group">
            <label>Full Name *</label>
            <input type="text" id="editName" value="<%= patient.name %>" required>
          </div>
          <div class="form-group">
            <label>Email *</label>
            <input type="email" id="editEmail" value="<%= patient.email %>" required>
          </div>
          <div class="form-group">
            <label>Phone</label>
            <input type="tel" id="editPhone" value="<%= patient.phone || '' %>">
          </div>
          <div class="form-group">
            <label>Age</label>
            <input type="number" id="editAge" value="<%= patient.age || '' %>" min="1" max="150">
          </div>
          <div class="form-group">
            <label>Gender</label>
            <select id="editGender">
              <option value="">Select Gender</option>
              <option value="Male" <%= patient.gender === 'Male' ? 'selected' : '' %>>Male</option>
              <option value="Female" <%= patient.gender === 'Female' ? 'selected' : '' %>>Female</option>
              <option value="Other" <%= patient.gender === 'Other' ? 'selected' : '' %>>Other</option>
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn-modal btn-cancel" onclick="closeEditModal()">
            Cancel
          </button>
          <button type="submit" class="btn-modal btn-submit">
            Save Changes
          </button>
        </div>
      </form>
    </div>
  </div>

  <%- include('../partials/logout-modal') %>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Patient Data -->
  <script type="application/json" id="patient-data">
    <%- JSON.stringify({
      id: patient._id,
      isBlocked: patient.isBlocked
    }) %>
  </script>

  <script>
    // Parse patient data
    const PATIENT_DATA = JSON.parse(
      document.getElementById('patient-data').textContent
    );
    const patientId = PATIENT_DATA.id;

    // Modal functions
    function showEditModal() {
      document.getElementById('editModal').classList.add('show');
    }

    function closeEditModal() {
      document.getElementById('editModal').classList.remove('show');
    }

    // Close modal on outside click
    document.getElementById('editModal').addEventListener('click', function(e) {
      if (e.target === this) {
        closeEditModal();
      }
    });

    // Edit form submission
    document.getElementById('editForm').addEventListener('submit', async function(e) {
      e.preventDefault();

      const formData = {
        name: document.getElementById('editName').value.trim(),
        email: document.getElementById('editEmail').value.trim(),
        phone: document.getElementById('editPhone').value.trim(),
        age: document.getElementById('editAge').value,
        gender: document.getElementById('editGender').value
      };

      try {
        const response = await fetch(`/admin/api/patients/${patientId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(formData)
        });

        const data = await response.json();

        if (response.ok && data.success) {
          alert('Patient updated successfully!');
          window.location.reload();
        } else {
          alert(data.error || 'Failed to update patient');
        }
      } catch (error) {
        console.error('Error:', error);
        alert('Error updating patient. Please try again.');
      }
    });

    // Toggle block/unblock
    async function toggleBlock() {
      const isBlocked = PATIENT_DATA.isBlocked;
      const action = isBlocked ? 'unblock' : 'block';

      if (!confirm(`Are you sure you want to ${action} this patient?`)) {
        return;
      }

      try {
        const response = await fetch(`/admin/api/patients/${patientId}/block`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ block: !isBlocked })
        });

        const data = await response.json();

        if (response.ok && data.success) {
          alert(`Patient ${action}ed successfully!`);
          window.location.reload();
        } else {
          alert(data.error || `Failed to ${action} patient`);
        }
      } catch (error) {
        console.error('Error:', error);
        alert(`Error ${action}ing patient. Please try again.`);
      }
    }

    // Delete patient
    async function deletePatient() {
      if (!confirm('Are you sure you want to delete this patient? This action cannot be undone.')) {
        return;
      }

      try {
        const response = await fetch(`/admin/api/patients/${patientId}`, {
          method: 'DELETE'
        });

        const data = await response.json();

        if (response.ok && data.success) {
          alert('Patient deleted successfully!');
          window.location.href = '/admin/patients';
        } else {
          alert(data.error || 'Failed to delete patient');
        }
      } catch (error) {
        console.error('Error:', error);
        alert('Error deleting patient. Please try again.');
      }
    }
  </script>

</body>
</html>