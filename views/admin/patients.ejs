<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Patients Management - Healora</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <link href="/css/admin/patients.css" rel="stylesheet">
  <link rel="stylesheet" href="/css/pagination.css">
  
</head>
<body>

  <%- include('../partials/admin-sidebar', { currentPage: 'patients' }) %>
  <%- include('../partials/admin-topbar', { admin: admin, breadcrumb: 'Patients' }) %>

  <div class="main-content">
    <div class="page-header">
      <div>
        <h1>Patients Management</h1>
        <p>Manage all patients and their information</p>
      </div>
      <button class="btn-add" onclick="showAddPatientModal()">
        <i class="fas fa-plus"></i>
        Add New Patient
      </button>
    </div>

    <div class="toolbar">
      <div class="search-wrapper">
        <i class="fas fa-search"></i>
        <input type="text" id="searchInput" class="search-input" placeholder="Search by name, email or phone...">
      </div>

      <div class="filter-wrapper">
        <i class="fas fa-venus-mars"></i>
        <select id="genderFilter" class="filter-select">
          <option value="">All Genders</option>
          <option value="Male">Male</option>
          <option value="Female">Female</option>
          <option value="Other">Other</option>
        </select>
      </div>

      <div class="filter-wrapper">
        <i class="fas fa-filter"></i>
        <select id="statusFilter" class="filter-select">
          <option value="">All Patients</option>
          <option value="active">Active</option>
          <option value="blocked">Blocked</option>
          <option value="inactive">Inactive</option>
        </select>
      </div>
    </div>

    <!-- Results info -->
    <div id="resultsInfo" style="padding: 0 0 10px 0; color: #64748b; font-size: 14px;"></div>

    <div class="patients-table-container">
      <table class="patients-table">
        <thead>
          <tr>
            <th>Patient</th>
            <th>Email</th>
            <th>Phone</th>
            <th>Age</th>
            <th>Gender</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="patientsTableBody">
          <tr>
            <td colspan="7">
              <div class="empty-state">
                <i class="fas fa-spinner fa-spin"></i>
                <p>Loading patients...</p>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <div id="pagination"></div>
  </div>

  <!-- Add Patient Modal -->
  <div class="modal-overlay" id="patientModal">
    <div class="modal-content-custom">
      <div class="modal-header">
        <h3 id="modalTitle">Add New Patient</h3>
        <button class="btn-close-modal" onclick="closePatientModal()">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <form id="patientForm">
        <div class="modal-body">
          <input type="hidden" id="patientId">

          <div class="form-group">
            <label>Full Name <span class="require-star">*</span></label>
            <input type="text" id="patientName" placeholder="Enter Full Name">
            <span class="error-message" id="errorName"></span>
          </div>

          <div class="form-group">
            <label>Email <span class="require-star">*</span></label>
            <input type="email" id="patientEmail" placeholder="patient@example.com">
            <span class="error-message" id="errorEmail"></span>
          </div>

          <div class="form-group">
            <label>Phone</label>
            <input type="tel" id="patientPhone" placeholder="1234567890">
            <span class="error-message" id="errorPhone"></span>
          </div>

          <div class="form-group">
            <label>Password <span class="require-star">*</span></label>
            <input type="password" id="patientPassword" placeholder="Min 6 characters">
            <span class="error-message" id="errorPassword"></span>
          </div>

          <div class="form-group">
            <label>Age</label>
            <input type="number" id="patientAge" placeholder="25" min="1" max="150">
            <span class="error-message" id="errorAge"></span>
          </div>

          <div class="form-group">
            <label>Gender</label>
            <select id="patientGender">
              <option value="">Select Gender</option>
              <option value="Male">Male</option>
              <option value="Female">Female</option>
              <option value="Other">Other</option>
            </select>
            <span class="error-message" id="errorGender"></span>
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn-modal btn-cancel" onclick="closePatientModal()">Cancel</button>
          <button type="submit" class="btn-modal btn-submit">Save Patient</button>
        </div>
      </form>
    </div>
  </div>

  <%- include('../partials/logout-modal') %>
  <%- include('../partials/loading') %>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="/js/alerts.js"></script>
  <script src="/js/loader.js"></script>
  <script src="/js/pagination.js"></script>
  <%- include('../partials/admin-scripts') %>

  <script>
    const state = {
      search: '',
      gender: '',
      status: '',
      page: 1,
      limit: 10,
      total: 0,
      totalPages: 0
    };

    async function loadPatients() {
      Loader.show('Loading patients...');

      try {
        const params = new URLSearchParams({
          search: state.search,
          gender: state.gender,
          status: state.status,
          page: state.page,
          limit: state.limit
        });

        const response = await fetch(`/admin/api/patients?${params}`);
        const data = await response.json();

        if (!data.success) throw new Error(data.error);

        state.total = data.pagination.total;
        state.totalPages = data.pagination.totalPages;

        renderPatients(data.patients);
        renderPagination();
        updateResultsInfo();

      } catch (error) {
        console.error('Error loading patients:', error);
        Alert.error('Failed to load patients');
      } finally {
        Loader.hide();
      }
    }

    function getStatus(patient) {
      if (patient.isBlocked) return `<span class="badge blocked">Blocked</span>`;
      if (!patient.isActive) return `<span class="badge inactive">Inactive</span>`;
      return `<span class="badge active">Active</span>`;
    }

    function renderPatients(patients) {
      const tbody = document.getElementById('patientsTableBody');

      if (!patients || patients.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="7">
              <div class="empty-state">
                <i class="fas fa-user-injured"></i>
                <h3>No patients found</h3>
                <p>Try adjusting your filters</p>
              </div>
            </td>
          </tr>`;
        return;
      }

      tbody.innerHTML = patients.map(patient => {
        const initials = patient.name.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
        const avatarHtml = patient.profileImage 
        ? `<img src="${patient.profileImage}" alt="${patient.name}" class="patient-avatar-img">`
        : `<div class="patient-avatar">${initials}</div>`;
        
        return `
        <tr>
          <td>
            <div class="patient-name">${avatarHtml}<div class="patient-info">
                  <h4>${patient.name}</h4>
                  <p>ID: ${patient._id.substring(0, 8)}</p>
                </div>
              </div>
            </td>
            <td>${patient.email}</td>
            <td>${patient.phone || '-'}</td>
            <td>${patient.age || '-'}</td>
            <td>${patient.gender || '-'}</td>
            <td>${getStatus(patient)}</td>
            <td>
              <div class="action-buttons">
                <button class="btn-action btn-view" onclick="viewPatientProfile('${patient._id}')">View</button>
              </div>
            </td>
          </tr>`;
      }).join('');
    }

    function renderPagination() {
      Pagination.init({
        totalItems: state.total,
        limit: state.limit,
        currentPage: state.page,
        onPageChange: (newPage) => {
          state.page = newPage;
          loadPatients();
        }
      });
      Pagination.render('pagination');
    }

    function updateResultsInfo() {
      const start = (state.page - 1) * state.limit + 1;
      const end = Math.min(state.page * state.limit, state.total);
      const info = state.total > 0
        ? `Showing <strong>${start}-${end}</strong> of <strong>${state.total}</strong> patients`
        : 'No patients found';
      document.getElementById('resultsInfo').innerHTML = info;
    }

    let searchTimeout;
    document.getElementById('searchInput').addEventListener('input', (e) => {
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(() => {
        state.search = e.target.value.trim();
        state.page = 1;
        loadPatients();
      }, 400);
    });

    document.getElementById('genderFilter').addEventListener('change', (e) => {
      state.gender = e.target.value;
      state.page = 1;
      loadPatients();
    });

    document.getElementById('statusFilter').addEventListener('change', (e) => {
      state.status = e.target.value;
      state.page = 1;
      loadPatients();
    });

    function viewPatientProfile(id) {
      window.location.href = `/admin/patient/${id}`;
    }

    function showAddPatientModal() {
      document.getElementById('modalTitle').textContent = 'Add New Patient';
      document.getElementById('patientForm').reset();
      clearErrors();
      document.getElementById('patientModal').classList.add('show');
    }

    function closePatientModal() {
      document.getElementById('patientModal').classList.remove('show');
      clearErrors();
    }

    function clearErrors() {
      document.querySelectorAll('.error-message').forEach(el => el.textContent = '');
    }

    document.getElementById('patientForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      clearErrors();

      const formData = {
        name: document.getElementById('patientName').value.trim(),
        email: document.getElementById('patientEmail').value.trim(),
        phone: document.getElementById('patientPhone').value.trim(),
        password: document.getElementById('patientPassword').value,
        age: document.getElementById('patientAge').value,
        gender: document.getElementById('patientGender').value
      };

      let hasError = false;
      if (formData.name.length < 3) { document.getElementById('errorName').textContent = 'Name must be at least 3 characters'; hasError = true; }
      if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(formData.email)) { document.getElementById('errorEmail').textContent = 'Invalid email format'; hasError = true; }
      if (formData.password.length < 6) { document.getElementById('errorPassword').textContent = 'Password must be at least 6 characters'; hasError = true; }
      if (hasError) return;

      Loader.show('Adding patient...');

      try {
        const response = await fetch('/admin/api/patients', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(formData)
        });

        const data = await response.json();
        Loader.hide();

        if (response.ok && data.success) {
          closePatientModal();
          Alert.success('Patient added successfully!');
          state.page = 1;
          loadPatients();
        } else {
          if (data.errors) {
            Object.keys(data.errors).forEach(field => {
              const el = document.getElementById(`error${field.charAt(0).toUpperCase() + field.slice(1)}`);
              if (el) el.textContent = data.errors[field];
            });
          } else {
            Alert.error(data.error || 'Failed to add patient');
          }
        }
      } catch (error) {
        Loader.hide();
        Alert.error('Error adding patient');
      }
    });

    document.addEventListener('DOMContentLoaded', loadPatients);
  </script>
</body>
</html>
