<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <title><%= title %></title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/css/admin/doctor.css">
  <link rel="stylesheet" href="/css/custom-alerts.css">
  <link rel="stylesheet" href="/css/pagination.css">

  
</head>
<body>

  <%- include('../partials/admin-sidebar', { currentPage: 'doctors' }) %>
  <%- include('../partials/admin-topbar', { admin: admin, breadcrumb: 'Doctors' }) %>

  <div class="main-content">
    <div class="page-header">
      <div>
        <h1>Doctors Management</h1>
        <p>Manage all doctors and their information</p>
      </div>
      <button class="btn-add" onclick="showAddDoctorModal()">
        <i class="fas fa-plus"></i>
        Add New Doctor
      </button>
    </div>

    <div class="toolbar">
      <div class="search-wrapper">
        <i class="fas fa-search"></i>
        <input type="text" id="searchInput" class="search-input" placeholder="Search by name, email or specialization...">
      </div>

      <div class="filter-wrapper">
        <i class="fas fa-building"></i>
        <select id="departmentFilter" class="filter-select">
          <option value="">All Departments</option>
        </select>
      </div>

      <div class="filter-wrapper">
        <i class="fas fa-filter"></i>
        <select id="statusFilter" class="filter-select">
          <option value="">All Status</option>
          <option value="active">Active</option>
          <option value="blocked">Blocked</option>
          <option value="inactive">Inactive</option>
        </select>
      </div>

      <div class="filter-wrapper">
        <i class="fas fa-sort"></i>
        <select id="sortFilter" class="filter-select">
          <option value="createdAt-desc">Latest</option>
          <option value="name-asc">Name (A-Z)</option>
          <option value="name-desc">Name (Z-A)</option>
          <option value="fee-asc">Fee (Low to High)</option>
          <option value="fee-desc">Fee (High to Low)</option>
          <option value="experience-desc">Experience (High to Low)</option>
          <option value="experience-asc">Experience (Low to High)</option>
        </select>
      </div>
    </div>

    <div id="resultsInfo" style="padding: 0 0 10px 0; color: #64748b; font-size: 14px;"></div>

    <div class="doctors-table-container">
      <table class="doctors-table">
        <thead>
          <tr>
            <th>Doctor</th>
            <th>Email</th>
            <th>Phone</th>
            <th>Specialization</th>
            <th>Department</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="doctorsTableBody">
          <tr>
            <td colspan="7">
              <div class="empty-state">
                <i class="fas fa-spinner fa-spin"></i>
                <p>Loading doctors...</p>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <div id="pagination"></div>
  </div>

  <div class="modal-overlay" id="doctorModal">
    <div class="modal-content-custom">
      <div class="modal-header">
        <h3 id="modalTitle">Add New Doctor</h3>
        <button class="btn-close-modal" onclick="closeDoctorModal()">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <form id="doctorForm">
        <div class="modal-body">
          <input type="hidden" id="doctorId">

          <!-- ── AVATAR SELECTOR ──────────────────── -->
          <div class="form-group">
            <label class="avatar-selector-label">
              Profile Avatar <span class="require-star">*</span>
            </label>
            <p class="avatar-selector-hint">Choose a default avatar or upload a custom photo</p>

            <div class="avatar-options">

              <!-- Male default -->
              <div class="avatar-option selected" data-value="/images/defaults/doctor-male.png" onclick="selectAvatar(this)">
                <div class="avatar-option-img-wrap">
                  <img src="/images/defaults/doctor-male.png" alt="Male Doctor">
                  <div class="avatar-check"><i class="fas fa-check"></i></div>
                </div>
                <span class="avatar-option-label">Male</span>
              </div>

              <!-- Female default -->
              <div class="avatar-option" data-value="/images/defaults/doctor-female.png" onclick="selectAvatar(this)">
                <div class="avatar-option-img-wrap">
                  <img src="/images/defaults/doctor-female.png" alt="Female Doctor">
                  <div class="avatar-check"><i class="fas fa-check"></i></div>
                </div>
                <span class="avatar-option-label">Female</span>
              </div>

               <div class="avatar-option upload-option" onclick="triggerAvatarUpload()">
                <div class="avatar-option-img-wrap upload-wrap" id="uploadWrap">
                  <img src="" alt="" id="uploadPreviewImg" style="display:none; width:100%; height:100%; object-fit:cover;">
                  <div class="upload-placeholder" id="uploadPlaceholder">
                    <i class="fas fa-camera"></i>
                    <span>Upload</span>
                  </div>
                  <div class="avatar-check"><i class="fas fa-check"></i></div>
                </div>
                <span class="avatar-option-label">Custom</span>
                <input type="file" id="customAvatarInput" accept="image/jpeg,image/png,image/webp"
                       style="display:none;" onchange="handleAvatarUpload(this)">
              </div>

            </div>

            <div class="avatar-live-preview">
              <div class="preview-circle">
                <img id="avatarLivePreview" src="/images/defaults/doctor-male.png" alt="Preview">
              </div>
              <div>
                <div class="preview-name" id="previewDoctorName">Dr. Name</div>
                <div class="preview-role" id="previewDoctorRole">Specialist</div>
              </div>
            </div>

            <p class="avatar-upload-note" id="avatarUploadNote">
              <i class="fas fa-info-circle"></i>
              Custom photo selected — will be saved with the doctor.
            </p>
          </div>

          <hr class="form-divider">

          <div class="form-group">
            <label>Full Name <span class="require-star">*</span></label>
            <input type="text" id="doctorName" placeholder="Full Name"
                   oninput="updateAvatarPreviewName(this.value)">
            <span class="error-message" id="errorName"></span>
          </div>

          <div class="form-group">
            <label>Email <span class="require-star">*</span></label>
            <input type="email" id="doctorEmail" placeholder="Email">
            <span class="error-message" id="errorEmail"></span>
          </div>

          <div class="form-group">
            <label>Phone <span class="require-star">*</span></label>
            <input type="tel" id="doctorPhone" placeholder="Phone Number">
            <span class="error-message" id="errorPhone"></span>
          </div>

          <div class="form-group">
            <label>Password <span class="require-star">*</span></label>
            <div style="display: flex; gap: 10px;">
              <input type="password" id="doctorPassword" placeholder="Min 6 characters" style="flex: 1;">
              <button type="button" onclick="generatePassword()" class="btn btn-secondary" style="white-space: nowrap;">
                <i class="fas fa-key"></i> Generate
              </button>
            </div>
            <span class="error-message" id="errorPassword"></span>
          </div>

          <div class="form-group">
            <label>Specialization <span class="require-star">*</span></label>
            <input type="text" id="doctorSpecialization" placeholder="e.g., Cardiologist"
                   oninput="updateAvatarPreviewRole(this.value)">
            <span class="error-message" id="errorSpecialization"></span>
          </div>

          <div class="form-group">
            <label>Department <span class="require-star">*</span></label>
            <select id="doctorDepartment">
              <option value="">Select Department</option>
            </select>
            <span class="error-message" id="errorDepartment"></span>
          </div>

        </div>

        <div class="modal-footer">
          <button type="button" class="btn-modal btn-cancel" onclick="closeDoctorModal()">Cancel</button>
          <button type="submit" class="btn-modal btn-submit">Save Doctor</button>
        </div>
      </form>
    </div>
  </div>

  <%- include('../partials/logout-modal') %>
  <%- include('../partials/loading') %>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="/js/alerts.js"></script>
  <script src="/js/loader.js"></script>
  <script src="/js/pagination.js"></script>
  <%- include('../partials/admin-scripts') %>

  <script>
    
    let selectedAvatarValue = '/images/defaults/doctor-male.png';

    function selectAvatar(el) {

      document.querySelectorAll('.avatar-option').forEach(opt => opt.classList.remove('selected'));
      el.classList.add('selected');

      selectedAvatarValue = el.dataset.value;
      document.getElementById('avatarLivePreview').src = selectedAvatarValue;

      document.getElementById('customAvatarInput').value = '';
      document.getElementById('uploadPreviewImg').style.display = 'none';
      document.getElementById('uploadPlaceholder').style.display = 'flex';
      document.getElementById('avatarUploadNote').style.display = 'none';
    }

    function triggerAvatarUpload() {
      document.getElementById('customAvatarInput').click();
    }

    function handleAvatarUpload(input) {
      if (!input.files || !input.files[0]) return;

      const file = input.files[0];

      if (file.size > 2 * 1024 * 1024) {
        Alert.error('Image too large. Please select an image under 2MB.');
        input.value = '';
        return;
      }

      const reader = new FileReader();
      reader.onload = (e) => {
        const dataUrl = e.target.result;

        const previewImg = document.getElementById('uploadPreviewImg');
        previewImg.src = dataUrl;
        previewImg.style.display = 'block';
        document.getElementById('uploadPlaceholder').style.display = 'none';

        document.getElementById('avatarLivePreview').src = dataUrl;

        document.querySelectorAll('.avatar-option').forEach(opt => opt.classList.remove('selected'));
        document.querySelector('.upload-option').classList.add('selected');

        selectedAvatarValue = dataUrl;

        document.getElementById('avatarUploadNote').style.display = 'flex';
      };
      reader.readAsDataURL(file);
    }

    function updateAvatarPreviewName(value) {
      const name = value.trim();
      document.getElementById('previewDoctorName').textContent = name ? `Dr. ${name}` : 'Dr. Name';
    }

    function updateAvatarPreviewRole(value) {
      document.getElementById('previewDoctorRole').textContent = value.trim() || 'Specialist';
    }

    function resetAvatarSelector() {

      selectedAvatarValue = '/images/defaults/doctor-male.png';
      document.getElementById('avatarLivePreview').src = selectedAvatarValue;
      document.querySelectorAll('.avatar-option').forEach(opt => opt.classList.remove('selected'));
      document.querySelector('.avatar-option[data-value="/images/defaults/doctor-male.png"]').classList.add('selected');
      document.getElementById('customAvatarInput').value = '';
      document.getElementById('uploadPreviewImg').style.display = 'none';
      document.getElementById('uploadPlaceholder').style.display = 'flex';
      document.getElementById('avatarUploadNote').style.display = 'none';
      document.getElementById('previewDoctorName').textContent = 'Dr. Name';
      document.getElementById('previewDoctorRole').textContent = 'Specialist';
    }

    const state = {
      search: '',
      department: '',
      status: '',
      sortBy: 'createdAt',
      sortOrder: 'desc',
      page: 1,
      limit: 10,
      total: 0,
      totalPages: 0
    };

    let allDepartments = [];

   async function loadDoctors() {
      Loader.show('Loading doctors...');
      try {
        const params = new URLSearchParams({
          search: state.search,
          department: state.department,
          status: state.status,
          sortBy: state.sortBy,
          sortOrder: state.sortOrder,
          page: state.page,
          limit: state.limit
        });

        const response = await fetch(`/admin/api/doctors?${params}`);
        const data = await response.json();

        if (!data.success) throw new Error(data.error);

        state.total = data.pagination.total;
        state.totalPages = data.pagination.totalPages;

        renderDoctors(data.doctors);
        renderPagination();
        updateResultsInfo();
      } catch (error) {
        Alert.error('Failed to load doctors');
      } finally {
        Loader.hide();
      }
    }

    async function loadDepartments() {
      try {
        const response = await fetch('/admin/api/departments');
        const data = await response.json();
        if (data.success) {
          allDepartments = data.departments || [];
          populateDepartmentDropdowns();
        }
      } catch (error) {
        console.error('Error loading departments:', error);
      }
    }

    function populateDepartmentDropdowns() {
      const filterSelect = document.getElementById('departmentFilter');
      const formSelect   = document.getElementById('doctorDepartment');

      filterSelect.innerHTML = '<option value="">All Departments</option>';
      formSelect.innerHTML   = '<option value="">Select Department</option>';

      allDepartments.forEach(dept => {
        if (!dept.isDeleted) {
          const o1 = document.createElement('option');
          o1.value = dept.name; o1.textContent = dept.name;
          filterSelect.appendChild(o1);

          const o2 = document.createElement('option');
          o2.value = dept.name; o2.textContent = dept.name;
          formSelect.appendChild(o2);
        }
      });
    }

    function getStatusBadge(status) {
      const map = {
        'active':   '<span class="badge badge-success">Active</span>',
        'blocked':  '<span class="badge badge-danger">Blocked</span>',
        'inactive': '<span class="badge badge-warning">Inactive</span>'
      };
      return map[status] || map['active'];
    }

    function renderDoctors(doctors) {
      const tbody = document.getElementById('doctorsTableBody');

      if (!doctors || doctors.length === 0) {
        tbody.innerHTML = `
          <tr><td colspan="7">
            <div class="empty-state">
              <i class="fas fa-user-doctor"></i>
              <h3>No doctors found</h3>
              <p>Try adjusting your filters</p>
            </div>
          </td></tr>`;
        return;
      }

      tbody.innerHTML = doctors.map(doctor => {
        const initials = doctor.name.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
        const avatarHtml = doctor.profileImage
          ? `<img src="${doctor.profileImage}" alt="${doctor.name}" class="doctor-avatar-img">`
          : `<div class="doctor-avatar">${initials}</div>`;

        return `
          <tr>
            <td>
              <div class="doctor-name">
                ${avatarHtml}
                <div class="doctor-info">
                  <h4>${doctor.name}</h4>
                  <p>ID: ${doctor._id.substring(0, 8)}</p>
                </div>
              </div>
            </td>
            <td>${doctor.email}</td>
            <td>${doctor.phone}</td>
            <td>${doctor.specialization}</td>
            <td>${doctor.department}</td>
            <td>${getStatusBadge(doctor.status)}</td>
            <td>
              <div class="action-buttons">
                <button class="btn-action btn-view" onclick="viewDoctorProfile('${doctor._id}')">View</button>
              </div>
            </td>
          </tr>`;
      }).join('');
    }

    function renderPagination() {
      Pagination.init({
        totalItems: state.total,
        limit: state.limit,
        currentPage: state.page,
        onPageChange: (newPage) => { state.page = newPage; loadDoctors(); }
      });
      Pagination.render('pagination');
    }

    function updateResultsInfo() {
      const start = (state.page - 1) * state.limit + 1;
      const end = Math.min(state.page * state.limit, state.total);
      document.getElementById('resultsInfo').innerHTML = state.total > 0
        ? `Showing <strong>${start}-${end}</strong> of <strong>${state.total}</strong> doctors`
        : 'No doctors found';
    }

    let searchTimeout;
    document.getElementById('searchInput').addEventListener('input', (e) => {
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(() => {
        state.search = e.target.value.trim();
        state.page = 1;
        loadDoctors();
      }, 400);
    });

    document.getElementById('departmentFilter').addEventListener('change', (e) => {
      state.department = e.target.value; state.page = 1; loadDoctors();
    });

    document.getElementById('statusFilter').addEventListener('change', (e) => {
      state.status = e.target.value; state.page = 1; loadDoctors();
    });

    document.getElementById('sortFilter').addEventListener('change', (e) => {
      const [sortBy, sortOrder] = e.target.value.split('-');
      state.sortBy = sortBy; state.sortOrder = sortOrder; state.page = 1; loadDoctors();
    });

    function viewDoctorProfile(id) {
      window.location.href = `/admin/doctor/${id}`;
    }

    function generatePassword() {
      const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%';
      let password = '';
      for (let i = 0; i < 12; i++) {
        password += chars.charAt(Math.floor(Math.random() * chars.length));
      }
      const field = document.getElementById('doctorPassword');
      field.value = password;
      field.type = 'text';
      Alert.success(`Generated: <strong>${password}</strong>`);
      setTimeout(() => { field.type = 'password'; }, 5000);
    }

    function showAddDoctorModal() {
      document.getElementById('modalTitle').textContent = 'Add New Doctor';
      document.getElementById('doctorForm').reset();
      clearErrors();
      resetAvatarSelector();
      document.getElementById('doctorModal').classList.add('show');
    }

    function closeDoctorModal() {
      document.getElementById('doctorModal').classList.remove('show');
      clearErrors();
      resetAvatarSelector();
    }

    function clearErrors() {
      document.querySelectorAll('.error-message').forEach(el => el.textContent = '');
    }

    document.getElementById('doctorForm').addEventListener('submit', async function (e) {
      e.preventDefault();
      clearErrors();

      const formData = {
        name:           document.getElementById('doctorName').value.trim(),
        email:          document.getElementById('doctorEmail').value.trim(),
        phone:          document.getElementById('doctorPhone').value.trim(),
        password:       document.getElementById('doctorPassword').value,
        specialization: document.getElementById('doctorSpecialization').value.trim(),
        department:     document.getElementById('doctorDepartment').value,
        profileImage:   selectedAvatarValue   
      };

      let hasError = false;
      if (formData.name.length < 3)                               { document.getElementById('errorName').textContent = 'Full name required (min 3 chars)'; hasError = true; }
      if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(formData.email))    { document.getElementById('errorEmail').textContent = 'Invalid email format'; hasError = true; }
      if (!/^[0-9]{10}$/.test(formData.phone))                   { document.getElementById('errorPhone').textContent = 'Phone must be 10 digits'; hasError = true; }
      if (formData.password.length < 6)                           { document.getElementById('errorPassword').textContent = 'Password must be at least 6 characters'; hasError = true; }
      if (!formData.specialization)                               { document.getElementById('errorSpecialization').textContent = 'Specialization is required'; hasError = true; }
      if (!formData.department)                                   { document.getElementById('errorDepartment').textContent = 'Department is required'; hasError = true; }
      if (hasError) return;

      Loader.show('Adding doctor...');

      try {
        const response = await fetch('/admin/api/doctors', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(formData)
        });

        const data = await response.json();
        Loader.hide();

        if (response.ok && data.success) {
          closeDoctorModal();
          Alert.success(data.message || 'Doctor added successfully!');
          state.page = 1;
          loadDoctors();
        } else {
          if (data.errors) {
            Object.keys(data.errors).forEach(field => {
              const el = document.getElementById(`error${field.charAt(0).toUpperCase() + field.slice(1)}`);
              if (el) el.textContent = data.errors[field];
            });
          } else {
            Alert.error(data.error || 'Failed to add doctor');
          }
        }
      } catch (error) {
        Loader.hide();
        Alert.error('Error adding doctor');
      }
    });

    document.addEventListener('DOMContentLoaded', async () => {
      await loadDepartments();
      await loadDoctors();
    });
  </script>
</body>
</html>
